<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Laravel</title>

    <!-- Fonts -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
        integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
        integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
        crossorigin="anonymous"></script>
    <!-- CDN de Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- CDN de Vue.js 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
</head>

<body>

    <div id="app" class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-lg-8 mb-3">
                <div class="input-group input-group-lg mb-3">
                    <input type="file" class="form-control fs-4 rounded-start" aria-describedby="inputGroupFileAddon04"
                        aria-label="Subir archivo" @change="handleFileUpload">
                    <button class="btn btn-primary rounded-end fs-4" type="button" @click="uploadVideo">Subir</button>
                </div>
                <p class="text-blue mt-3 text-center">{{ statusUpload }}</p>
            </div>
        </div>

        <div class="row justify-content-center">
            <div class="col-5">
                <div v-for="agente in agents" :key="agente._id" class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" :value="agente" v-model="agentesSeleccionados"
                        id="flexCheckDefault">
                    <label class="form-check-label" :for="agente">{{ agente.rol }}</label>
                </div>
                <button class="btn btn-secondary mt-3 mb-3" @click="toggleEdit">{{ editMode ? 'Guardar' : 'Editar'
                    }}</button>
            </div>
        </div>

        <div class="row justify-content-center mt-3" v-if="editMode">
            <div class="col-lg-8 p-4">
                <div v-for="p in agentesSeleccionados" :key="p._id" class="input-group mb-4 fs-8 fw-lighter">
                    <span class="input-group-text">Sistema de Prompts</span>
                    <textarea class="form-control" v-model="p.prompt" aria-label="Prompt"
                        style="font-size: 14px;"></textarea>
                    <button class="btn btn-warning rounded-end" type="button"
                        @click="uploadSystemPrompt(p)">Actualizar</button>
                    <div class="mt-2 ms-4 ">{{ p.description }}</div>
                </div>
            </div>
        </div>

        <div class="row justify-content-center mt-3">
            <div v-if="loaderTranscription" class="col-5 text-center">
                <div class="spinner-border text-info" role="status">
                    <span class="visually-hidden">Cargando</span>
                </div>
                <div><span>Generando transcripción...</span></div>
            </div>
            <div v-else class="col-5 card">
                <div class="card-body">
                    <h3 class="card-title text-center">Transcripción:</h3>
                    <p class="card-text mt-3">{{transcription}}</p>
                </div>
            </div>

            <div v-if="loaderInference" class="col-5 text-center">
                <div class="spinner-border text-info" role="status">
                    <span class="visually-hidden">Cargando</span>
                </div>
                <div><span>Generando inferencia...</span></div>
            </div>
            <div v-else class="col-5">
                <div class="card" v-for="(response, index) in inferencias" :key="index">
                    <div class="card-body">
                        <h5 class="card-title">Inferencia: {{ agentesSeleccionados[index].rol }}</h5>
                        <p class="card-text">{{ response }}</p>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Modales de estado -->
  <!-- Modales de estado -->
        <!-- Modales de estado -->
        <div class="modal fade" id="statusModal" tabindex="-1" aria-labelledby="statusModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="statusModalLabel">{{ modalTitle }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>{{ modalMessage }}</p>
                    </div>
                </div>
            </div>
        </div>

    <script>
        const { createApp, ref, onMounted, watch } = Vue

        createApp({
            setup() {
                const inferenciaNames = ref(['Evaluador', 'Resumen', 'Otra inferencia']);

                const apiHost = 'http://186.28.221.82:1905';
                const selectedVideoFile = ref(null);
                const loader = ref(false);
                const loaderTranscription = ref(false);
                const loaderInference = ref(false);
                const alert = ref(false);
                const statusUpload = ref(null);
                const transcription = ref(null);
                const inferencia = ref(null);
                const promptSystem = ref([]);
                const agents = ref([]);
                const agentesSeleccionados = ref([]);
                const inferencias = ref([]);
                const editMode = ref(false);
                const modalTitle = ref('');
                const modalMessage = ref('');

                const handleFileUpload = (event) => {
                    selectedVideoFile.value = event.target.files[0];
                    const fileExtension = selectedVideoFile.value.name.split('.').pop().toLowerCase();
                    if (fileExtension !== 'mp4') {
                        alert('Solo se permiten archivos MP4.');
                        selectedVideoFile.value = '';
                        return;
                    }
                };

                const toggleEdit = () => {
                    editMode.value = !editMode.value;
                };

                const showModal = (title, message) => {
                    modalTitle.value = title;
                    modalMessage.value = message;
                    const modal = new bootstrap.Modal(document.getElementById('statusModal'));
                    modal.show();
                    setTimeout(() => {
                        modal.hide();
                    }, 2000);
                };

        const uploadVideo = async () => {
            if (!selectedVideoFile.value) {
                new bootstrap.Modal(document.getElementById('alertModal')).show();
                return;
            }
            loaderTranscription.value = true;
            loaderInference.value = true;
            showModal('Cargando', 'Generando transcripción...');

            const formData = new FormData();
            formData.append('video', selectedVideoFile.value);

            try {
                const response = await axios.post(`${apiHost}/transcription/video`, formData);
                if (response.status !== 200) {
                    statusUpload.value = 'Error al subir el archivo';
                    showModal('Error', 'Error generando la transcripción');
                } else {
                    statusUpload.value = 'Archivo subido correctamente';
                    transcription.value = response.data.text;
                    inferencias.value = await getInferences();
                    showModal('Éxito', 'Transcripción completada');
                }
            } catch (error) {
                statusUpload.value = error.message;
                showModal('Error', 'Error generando la transcripción');
            } finally {
                loaderTranscription.value = false;
                loaderInference.value = false;
            }
        };

        const uploadSystemPrompt = async (agent) => {
            try {
                const response = await axios.put(`${apiHost}/agents/${agent._id}`, {
                    prompt: agent.prompt,
                });
                if (response.status !== 200) {
                    statusUpload.value = 'Error actualizando el prompt system';
                    showModal('Error', `Error actualizando el prompt para ${agent.rol}`);
                } else {
                    statusUpload.value = 'Prompt actualizado correctamente';
                    const updatedAgent = response.data;
                    const index = agents.value.findIndex(a => a._id === agent._id);
                    if (index !== -1) {
                        agents.value[index] = updatedAgent;
                    }
                    showModal('Éxito', `Prompt actualizado para ${agent.rol}`);
                }
            } catch (error) {
                statusUpload.value = error.message;
                showModal('Error', `Error actualizando el prompt para ${agent.rol}`);
            }
        };

        const getInferenceForAgent = async (id, prompt) => {
            try {
                const payload = { text: prompt };
                const response = await axios.post(`${apiHost}/agents/${id}/inference`, payload);
                if (response.status !== 200) {
                    statusUpload.value = 'Error obteniendo la inferencia';
                    showModal('Error', `Error generando la inferencia para el agente ${id}`);
                }
                return response.data.inference.content;
            } catch (error) {
                statusUpload.value = error.message;
                showModal('Error', `Error generando la inferencia para el agente ${id}`);
            }
        };

        const getInferences = async () => {
            const inferences = await Promise.all(
                agentesSeleccionados.value.map(async (agent) => {
                    showModal('Cargando', `Generando inferencia para ${agent.rol}`);
                    const inference = await getInferenceForAgent(agent._id, transcription.value);
                    showModal('Éxito', `Inferencia completada para ${agent.rol}`);
                    return inference;
                })
            );
            return inferences;
        };

        const getAgents = async () => {
            try {
                const response = await axios.get(`${apiHost}/agents`);
                if (response.status !== 200) {
                    console.log('Error obteniendo los agentes');
                } else {
                    agents.value = response.data;
                    console.log('Agentes obtenidos del servidor:', agents.value);
                }
            } catch (error) {
                statusUpload.value = error.message;
            }
        };

        onMounted(async () => {
            await getAgents();
            console.log('Agentes cargados:', agents.value);
        });

        watch(agentesSeleccionados, async () => {
            await getAgents();
        });

        return {
            handleFileUpload,
            uploadVideo,
            loaderTranscription,
            loaderInference,
            alert,
            statusUpload,
            transcription,
            inferencia,
            promptSystem,
            agents,
            uploadSystemPrompt,
            agentesSeleccionados,
            inferencias,
            editMode,
            toggleEdit,
            inferenciaNames,
            modalTitle,
            modalMessage
        };
        }
        }).mount('#app')
            </script>

            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
                integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
                crossorigin="anonymous"></script>

        </body>

        </html>